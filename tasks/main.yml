---
# --------------------------------

- name: 'download archive'
  ansible.builtin.get_url:
    url: '{{hashicorp_repo}}/consul/{{item.version}}/consul_{{item.version}}_{{hashicorp_arch}}.{{consul_format}}'
    dest: '{{hashicorp_dir_staging}}/consul_{{item.version}}_{{hashicorp_arch}}.{{consul_format}}'
    timeout: '{{hashicorp_internet_timeout}}'
    validate_certs: false
  loop: '{{consul_builds}}'
  when: item.state == 'present'
  tags: [ct-consul]

- name: 'create package directories'
  ansible.builtin.file:
    state: directory
    owner: root
    group: root
    mode: '0755'
    path: '{{hashicorp_dir_pkg}}/consul/{{item.version}}'
  loop: '{{consul_builds}}'
  when: item.state == 'present'
  become: true
  tags: [ct-consul]

- name: 'expand archive'
  ansible.builtin.unarchive:
    src: '{{hashicorp_dir_staging}}/consul_{{item.version}}_{{hashicorp_arch}}.{{consul_format}}'
    dest: '{{hashicorp_dir_pkg}}/consul/{{item.version}}'
    copy: false
  loop: '{{consul_builds}}'
  when: item.state == 'present'
  ignore_errors: '{{ansible_check_mode}}'
  become: true
  tags: [ct-consul]

- name: 'create symlink to active binary'
  ansible.builtin.file:
    dest: '{{hashicorp_dir_bin}}/consul'
    src: '{{hashicorp_dir_pkg}}/consul/{{consul_version}}/consul'
    state: link
  ignore_errors: '{{ansible_check_mode}}'
  become: true
  tags: [ct-consul]

- name: 'push bash include'
  ansible.builtin.template:
    src: consul.sh.j2
    dest: /usr/local/etc/bash.d/consul.sh
    owner: root
    group: root
    mode: 0644
  become: true
  tags: [ct-consul]

- name: 'directories'
  ansible.builtin.file:
    state: directory
    path: '{{item}}'
    owner: root
    group: root
    mode: '0755'
  loop: '{{consul_dirs}}'
  become: true
  tags: [ct-consul]

- name: 'system account'
  ansible.builtin.user:
    name: consul
    comment: 'Consul system account'
    system: true
    state: present
  become: true
  tags: [ct-consul]

- name: 'render {{consul_role}} config (NL)'
  ansible.builtin.template:
    src: '{{consul_role}}.json.j2'
    dest: '{{consul_etc_dir}}/{{consul_role}}.json'
    owner: root
    group: root
    mode: '0600'
  when: (consul_servers | length) > 0
  notify: handler_reload_consul
  no_log: true
  become: true
  tags: [ct-consul]

- name: 'render systemd unit file'
  ansible.builtin.template:
    src: consul-{{consul_role}}.service.j2
    dest: /etc/systemd/system/consul-{{consul_role}}.service
    owner: root
    group: root
    mode: '0600'
  register: reg_service
  become: true
  tags: [ct-consul]

- name: 'consul-{{consul_role}} service to {{consul_state}}'
  ansible.builtin.systemd:
    name: consul-{{consul_role}}
    state: '{{consul_state}}'
    enabled: true
    daemon_reload: '{{reg_service is changed}}'
  when: (consul_servers | length) > 0
  become: true
  tags: [ct-consul]

# --------------------------------
...
